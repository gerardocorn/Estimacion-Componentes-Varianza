---
title: "Solución Trabajo Encargado 3"
subtitle: "Segunda Especialidad"
author: "Gerardo Mamani"
date: "Chachapoyas, `r Sys.Date()`"
format: html
editor: visual
---

Directorio de trabajo

```{r}
rm(list = ls())
```

```{r}
setwd("~/Documents/1Teach/UNA/MejoraGeneticaEvaluacion_2023/TrabajoEncargado")
```

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(kableExtra)
library(optiSel)
```

<br>

Con los siguientes datos:

- Un archivo de pedigri de alpacas 
- Un archivo de fenotipo  con el siguiente detalle de sus columnas 

```{yaml}
IId          year sex Population DF    PV   DEN
huacaya12632 2013 F   Macusani   25.01 5.19 23.83
huacaya12633 2013 M   Macusani   23.40 4.74 23.60
```

```{yaml}
Donde: 
            IId = identificación del animal
           year = anho de nacimiento
            sex = sexo del animal
     Population = población de origen
             DF = Diametro de fibra (um)
             PV = Peso vellón (libras)
            DEN = Densidad de fibra (número )
```

Resolver:

## 1. Cual es promedio de DF en alpacas de la población de Marangani? (2pts)

```{r}
options(stringsAsFactors = F)
fenotipo <- read.table("huacaya_fenotipo.txt", header = TRUE, na.strings = "NA")
```

```{r}
fenotipo %>% 
  group_by(Population) %>% 
  get_summary_stats(DF, type = "mean_sd") %>%
  select(-variable) %>%
  kable()
```
```{r, warning=FALSE, message=FALSE}
library(ggstatsplot)
```

```{r, warning=FALSE}
ggbetweenstats(
  data  = fenotipo,
  x     = Population,
  y     = DF,
  title = "Diametro de fibra",
  centrality.type = "p",
  ggtheme = ggplot2::theme_gray()
) + ## modifying the plot further
  ggplot2::scale_y_continuous(
    limits = c(15, 45),
    breaks = seq(from = 15, to = 45, by = 5)
  )
```

## 2. Cual es el promedio de PV en alpacas machos de la población de Cojata? (2pts)

```{r}
fenotipo %>% 
  group_by(Population, sex) %>% 
  filter(Population == "Cojata", sex == "M") %>% 
  get_summary_stats(PV, type = "mean_sd") %>%
  select(-variable) %>%
  kable()
```

```{r}
ggbetweenstats(
  data  = fenotipo,
  x     = Population,
  y     = PV,
  title = "Peso de Vellón",
  centrality.type = "p",
  pairwise.comparisons = FALSE,
  results.subtitle = FALSE,
  ggtheme = ggplot2::theme_gray()) +
theme(axis.title.y.right = element_blank(), 
  axis.text.y.right = element_blank(), 
  axis.ticks.y.right = element_blank())
```

```{r}
fenotipo %>%
  grouped_ggbetweenstats(
    ## arguments relevant for ggbetweenstats
    x = Population,
    y = PV,
    grouping.var = sex,
    xlab = "Población",
    ylab = "Peso vellón",
    pairwise.display = "significant", ## display only significant pairwise comparisons
    p.adjust.method = "fdr", ## adjust p-values for multiple tests using this method
    # ggtheme = ggthemes::theme_tufte(),
    package = "ggsci",
    palette = "default_jco",
    ## arguments relevant for combine_plots
    annotation.args = list(title = "Peso vellón"),
    plotgrid.args = list(nrow = 1)
  )
```


## 3. Cual es la varianza de DEN en alpacas de la población de Macusani? (2pts)

```{r}
fenotipo %>% 
  group_by(Population) %>% 
  summarise(N = n(),
         mean = mean(DEN),
           sd = sd(DEN),
          var = sd^2) %>%
  kable()
```

## 4. Cual es la correlacion fenotipica entre DF, PV y DEN ? 

```{r}
ggcorrmat(
  data = fenotipo,  ## data from which variable is to be taken
  cor.vars = DF:DEN ## specifying correlation matrix variables
  )
```

## 5. Cual es la heredabilidad de DF? (2pts)

```{r, eval=FALSE, results='hide', collapse=TRUE}
command <- "./renumf90 param_VCE.txt"
system(command)
```

```{r, eval=FALSE, results='hide'}
command <- "./blupf90+ renf90.par"
system(command)
```

```{yaml}
Final Estimates
 Genetic variance(s) for effect  4       
   1.0045    
 Residual variance(s)
   1.0812    
* Warning * may need to increase # samples     0     2
  
 Sampling variances of covariances function of random effects (n=10000)
  
H2_t1  - Function: g_4_4_1_1/(g_4_4_1_1+r_1_1)
  Mean:   0.48161    
  Sample Mean:   0.48161    
  Sample SD:    0.0000    
 elapsed time  7.4539185E-03
 *** Statistical Method: VCE                 
 * FINISHED (BLUPF90): 11-29-2023  07h 26m 10s 025
```

Calculando la $h^2$ para diámetro de fibra

```{r}
va <- 1.2576   # varianza aditiva
ve <- 1.3515   # varianza residual
vp <- va + ve  # varianza fenotipica 
h2 <- va/vp
h2
```

## 6. ¿Cual es la heredabildiad de PV? (2pts)

```{r, eval=FALSE, results='hide', collapse=TRUE}
command <- "./renumf90 param_VCE.txt"
system(command)
```

```{r, eval=FALSE, results='hide'}
command <- "./blupf90+ renf90.par"
system(command)
```

```{yaml}
Final Estimates
 Genetic variance(s) for effect  4       
   1.1991    
 Residual variance(s)
   2.0102    
* Warning * may need to increase # samples     0     2
  
 Sampling variances of covariances function of random effects (n=10000)
  
H2_t1  - Function: g_4_4_1_1/(g_4_4_1_1+r_1_1)
  Mean:   0.37363    
  Sample Mean:   0.37363    
  Sample SD:    0.0000    
 elapsed time  5.9127808E-03

 ** WARNING: All traits are missing; eliminate such records!

 *** Statistical Method: VCE                 
 * FINISHED (BLUPF90): 11-29-2023  07h 45m 18s 406
```

Calculando la $h^2$ para peso vellón


```{r}
va <- 1.1991   # varianza aditiva
ve <- 2.0102   # varianza residual
vp <- va + ve  # varianza fenotípica 
h2 <- va/vp
h2
```

## 7. Cual es la heredabilidad en DEN? (2pts)

```{r, eval=FALSE, results='hide', collapse=TRUE}
command <- "./renumf90 param_VCE.txt"
system(command)
```

```{r, eval=FALSE, results='hide'}
command <- "./blupf90+ renf90.par"
system(command)
```

```{yaml}
Final Estimates
 Genetic variance(s) for effect  4       
   1.0045    
 Residual variance(s)
   1.0812    
* Warning * may need to increase # samples     0     2
  
 Sampling variances of covariances function of random effects (n=10000)
  
H2_t1  - Function: g_4_4_1_1/(g_4_4_1_1+r_1_1)
  Mean:   0.48161    
  Sample Mean:   0.48161    
  Sample SD:    0.0000    
 elapsed time  5.8364868E-03
 *** Statistical Method: VCE                 
 * FINISHED (BLUPF90): 11-29-2023  07h 47m 33s 134
```

```{r}
va <- 1.0045   # varianza aditiva
ve <- 1.0812   # varianza residual
vp <- va + ve  # varianza fenotípica 
h2 <- va/vp
h2
```


## 8. Haga un ranking de las 10 alpacas machos con mayor EBV para DF. (2pts)

```{r, eval=FALSE, results='hide', collapse=TRUE}
command <- "./renumf90 param_BLUP.txt"
system(command)
```

```{r, eval=FALSE, results='hide'}
command <- "./blupf90+ renf90.par"
system(command)
```

```{yaml}
finished peds (BLUP) in 1.86 s,  136153 nonzeroes

 solutions and s.e. stored in file: "solutions.orig"
 FSPAK90 (YAMS): An error occurred.
 Abnormal parameters or arguments.  
```

```{r}
system("cp solutions.orig solutions_DF.orig")
```

```{r}
sEBV_DF0 <- read.table("solutions_DF.orig", skip = 16)
sEBV_DF <- sEBV_DF0 %>% 
  select(-c(V1, V2, V3, V6)) %>% 
  arrange(-V5) %>% 
  rename(animal = V4, EBV_df = V5, ) 
```

```{r}
pedigree <- read.table("huacaya_pedigri.txt", header = T)
pedigree2 <- prePed(pedigree)
```

```{r}
todo1 <- merge(pedigree2, sEBV_DF, by.x = "Indiv", by.y = "animal")
```

```{r}
todo1 %>% 
  filter(Sex == "male") %>%  
  mutate(DEP_df = EBV_df/2) %>% 
  select(-c("Sire", "Dam", "EBV_df", "Offspring")) %>% 
  arrange(DEP_df) %>% 
  head(10) %>%
  kbl()
```

## 9. Haga un ranking de las 10 alpacas machos con mayor DEP para PV. (2pts)

```{r, eval=FALSE, results='hide', collapse=TRUE}
command <- "./renumf90 param_BLUP.txt"
system(command)
```

```{r, eval=FALSE, results='hide'}
command <- "./blupf90+ renf90.par"
system(command)
```

```{yaml}
finished peds (BLUP) in 1.66 s,  136153 nonzeroes

 solutions and s.e. stored in file: "solutions.orig"
 FSPAK90 (YAMS): An error occurred.
 Abnormal parameters or arguments.   
```


```{r}
system("cp solutions.orig solutions_PV.orig")
```

```{r}
sEBV_PV0 <- read.table("solutions_PV.orig", skip = 16)
sEBV_PV <- sEBV_PV0 %>% 
  select(-c(V1, V2, V3, V6)) %>% 
  arrange(-V5) %>% 
  rename(animal = V4, EBV_pv = V5, ) 
```

```{r}
pedigree <- read.table("huacaya_pedigri.txt", header = T)
pedigree2 <- prePed(pedigree)
```

```{r}
todo2 <- merge(pedigree2, sEBV_PV, by.x = "Indiv", by.y = "animal")
```

```{r}
todo2 %>% 
  filter(Sex == "male") %>%  
  arrange(-EBV_pv) %>% 
  mutate(DEP_pv = EBV_pv/2) %>% 
  select(-c("Sire", "Dam", "EBV_pv", "Offspring")) %>% 
  head(10) %>%
  kbl()
```

## 10 Haga un ranking de las 10 alpacas hembras con mayor DEP para DEN (2pts)

```{r, eval=FALSE, results='hide', collapse=TRUE}
command <- "./renumf90 param_BLUP.txt"
system(command)
```

```{r, eval=FALSE, results='hide'}
command <- "./blupf90+ renf90.par"
system(command)
```

```{yaml}
finished peds (BLUP) in 1.57 s,  136153 nonzeroes

 solutions and s.e. stored in file: "solutions.orig"
 FSPAK90 (YAMS): An error occurred.
 Abnormal parameters or arguments.    
```

```{r}
system("cp solutions.orig solutions_DEN.orig")
```

```{r}
sEBV_DEN0 <- read.table("solutions_DEN.orig", skip = 16)
sEBV_DEN <- sEBV_DEN0 %>% 
  select(-c(V1, V2, V3, V6)) %>% 
  arrange(-V5) %>% 
  rename(animal = V4, EBV_den = V5, ) 
```

```{r}
pedigree <- read.table("huacaya_pedigri.txt", header = T)
pedigree2 <- prePed(pedigree)
```

```{r}
todo3 <- merge(pedigree2, sEBV_DEN, by.x = "Indiv", by.y = "animal")
```

```{r}
todo3 %>% 
  filter(Sex == "female") %>%  
  arrange(-EBV_den) %>% 
  mutate(DEP_den = EBV_den/2) %>% 
  select(-c("Sire", "Dam", "EBV_den", "Offspring")) %>% 
  head(10) %>%
  kbl()
```





